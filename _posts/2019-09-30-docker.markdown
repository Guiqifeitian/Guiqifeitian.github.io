---
layout: post
title:  "Docker it!"
date:   2019-09-30 15:58:18
categories: blog
description: something about docker
published: true
---

### 常用命令

##### 通过ssh挂载到远程主机的目录

```
# 先数据卷驱动，下载vieux/sshfs
docker plugin install --grant-all-permissions vieux/sshfs

#创建数据卷
docker volume create --driver vieux/sshfs -o sshcmd=username@172.17.122.24:/work/nginx -o password=passwd sshvolume

#使用该数据卷
docker run -d --name nginx -v sshvolume:/usr/share/nginx/html nginx
```

##### 通过nfs挂载远程主机的目录

```
#创建数据卷
docker volume create --driver local -o type=nfs -o o=addr=192.168.1.1,rw -o device=:/path/to/dir nfsvolume
docker run -d --name nginx -v nfsvolume:/usr/share/nginx/html nginx
```

##### 首次启动并挂载到本地的空目录

```
docker volume create --driver local -o type=none -o device=/work/volume -o o=bind localvolume
docker run -d --name nginx -v localvolume:/usr/share/nginx/html nginx
```

##### 删除所有未被使用的数据卷

```
docker volume prune -f
```

##### 修改docker安装目录

docker默认安装的目录是在/var/lib/docker目录下，如果需要修改到其他目录，可以做如下方法

1. 将/var/lib/docker内容复制到其他目录，然后建个软连接
2. 对于版本大于 v17.05.0，修改/etc/docker/daemon.json,加入"data-root": "/store/software/docker"

然后重启docker服务

##### 打包并导入镜像

```
docker save -o ubuntu.tar ubuntu:16.04
docker load -i ubuntu.tar
```

##### Dockerfile

```
FROM ubuntu:16.04

RUN mkdir -p /work/29418

COPY code /work/29418
```

##### 配置btrfs文件驱动

1. 将docker的安装目录移动到btrfs问价系统上的目录上

2. 在/etc/docker/daemon.json文件中添加配置

```
"storage-driver":"btrfs"
```

重启docker服务，通过`docker info`查看Storage Driver的类型是btrfs


在容器里面可以使用btrfs的子卷和快照功能，但是无法查看和删除子卷，但是在容器外面却可以


在容器外面查看子卷的情况

`btrfs subvolume list ./`

![avatar](/assets/images/btrfs_subvolume.png)

可以看到，如果配置了btrfs驱动，每次启动一个容器docker就会自动新建对应的subvolume，图中最后俩个subvolume是在容器内部新建的

```
btrfs subvolume create subvolume1
btrfs subvolume snapshot subvolume1 subvolume1_snapshot  #会新建一个subvolume1_snapshot的目录，内容和subvolume1一样，但是却不会占用双倍的空间
```

##### 将正在运行的容器打包成镜像

```
sudo docker commit -a "guishaoli@github.com" -m "with some software installed" 593d2327c2c8 ubuntu:custom
```
